# 싱글 스레드와 멀티 스레드를 각각 어떤 상황에서 써야 할까요?

대표적으로 멀티 스레드와 싱글 스레드를 비교할 수 있는 두가지 경우가 있다.

- Spring vs NodeJs
- Apache VS Nginx

정확히는 **멀티 스레드 구조**(Spring)와 **싱글 스레드 이벤트 루프 구조**(NodeJs)에 대한 차이가 된다.

## Spring vs NodeJs

Spring의 경우 스레드 풀을 가지고 있어서 요청이 클라이언트로부터 요청이 들어오면 **스레드 풀에서 가용한 스레드를 해당 요청에게 할당**하는 형식으로 요청에 대한 응답을 한다.  
만약 가용한 스레드가 스레드 풀에 남아있지 않다면 응답을 마치고 반환 될 스레드를 계속해서 기다리게 된다.

NodeJs의 경우 이벤트 루프 구조이기 때문에 **클라이언트의 요청을 이벤트 큐에 계속해서 쌓아놓는다**.  
이벤트 루프는 무한 루프를 돌면서 이벤트 큐에 요청이 있을때 까지 기다리다가 요청이 큐에 들어오면 하나씩 처리해 나간다.

이때 요청을 처리함에 있어 단 하나의 스레드만 사용하는 것으로 착각 할 수 있는데 실상은 그렇지 않다.

먼저 작업의 종류를 비동기적으로 처리해도 되는지를 판단한뒤 다음 과정을 따른다.

- **비동기**적으로 처리할 수 있다면 **이벤트 루프가 처리하여 응답**을 내보낸다.
- **동기**적으로 처리해야 한다면 이벤트 루프가 처리하지 않고 **새로운 스레드를 할당하여 해당 이벤트를 위임**한다.

따라서 **비동기적으로 처리해도 문제가 되지 않는 요청**이 많이 들어오는 경우 멀티 스레드 구조보다 **싱글 스레드 이벤트 루프 구조**가 요청을 처리하기 쉽고 **더 효율적**인 구조가 된다.

이렇게 보면 싱글 스레드 이벤트 루프 구조가 무조건 더 좋아 보일수도 있다.  

하지만 **환경에 따라** **멀티 스레드 구조**는 싱글 스레드보다 **자원의 활용이 좋기 때문에 응답성이 더 뛰어나다**.

만약 **CPU의 개수가 많고 Blocking I/O가 많이 요청**된다면 싱글 스레드 기반 구조보다 **멀티 스레드 기반 구조가 더 빠를 것**이다.   
ex. 데이터 베이스와 연관되어 데이터의 정합성이 중요한 작업요청이 많이 들어오게 되는 경우 멀티 스레드 기반 구조가 더 빠를것이다.

>Blocking : 유저 프로세스가 시스템 호출을 하고나서 결과가 반환되기까지 다음 처리로 넘어가지 않음 
>Non-Blocking : 호출한 직후에 프로그램으로 제어가 돌아와서 시스템 호출의 종료를 기다리지 않고 다음 처리로 넘어갈 수 있음      

## Apache VS Nginx

Apache의 경우 요청이 들어올 경우 계속해서 새로운 스레드를 할당해야 하기 때문에 CPU와 메모리 사용율이 올라가게 되고 서버의 부하로 이어진다.

하지만 Nginx의 경우 Listner 프로세스가 계속해서 요청을 받고 Worker 프로세스가 요청을 처리한다.  
따라서 Worker가 요청을 처리하고 있는 중에도 Listner는 요청을 계속 받아들이기 때문에 요청이 많이 들어와도 CPU와 메모리 사용율이 크게 증가하지 않는다.

따라서 트래픽을 많이 받아서 견뎌야하는 쪽에서는 Nginx를 사용하는 것이 더 좋은 선택이 될 수 있다.

> 벤치마크
>
> http://blog.naver.com/PostView.nhn?blogId=tmondev&logNo=220737182315&redirect=Dlog&widgetTypeCall=true



> 참고

https://mygumi.tistory.com/154

https://stackoverflow.com/questions/10110660/misunderstanding-the-difference-between-single-threading-and-multi-threading-pro